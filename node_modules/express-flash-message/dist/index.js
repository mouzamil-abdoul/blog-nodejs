"use strict";
var __spreadArrays = (this && this.__spreadArrays) || function () {
    for (var s = 0, i = 0, il = arguments.length; i < il; i++) s += arguments[i].length;
    for (var r = Array(s), k = 0, i = 0; i < il; i++)
        for (var a = arguments[i], j = 0, jl = a.length; j < jl; j++, k++)
            r[k] = a[j];
    return r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.flash = function (options) { return function (req, response, next) {
    if (!req.session) {
        throw new Error('no session detected!');
    }
    var keyName = options ? (options.sessionKeyName ? options.sessionKeyName : 'flash') : 'flash';
    req.flash = function (event, message) {
        return new Promise(function (res, rej) {
            if (!req.session[keyName]) {
                req.session[keyName] = {};
            }
            if (!req.session[keyName][event]) {
                req.session[keyName][event] = [];
            }
            req.session[keyName][event].push(message);
            req.session.save(function (err) {
                if (err) {
                    return rej(err);
                }
                res();
            });
        });
    };
    req.consumeFlash = function (event) {
        return new Promise(function (res, rej) {
            var messages = [];
            if (req.session[keyName] && req.session[keyName][event]) {
                messages = __spreadArrays(req.session[keyName][event]);
                req.session[keyName] = null;
            }
            req.session.save(function (err) {
                if (err) {
                    return rej(err);
                }
                res(messages);
            });
        });
    };
    next();
}; };
